"use strict";var p=Object.defineProperty;var m=(t,e,i)=>e in t?p(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var d=(t,e,i)=>(m(t,typeof e!="symbol"?e+"":e,i),i);const n=require("electron"),r=require("path"),c=require("child_process"),h=()=>{n.ipcMain.on("ffmpegCommandExec",(t,e)=>{console.log(e);const i=c.exec(e);setTimeout(()=>{console.log("Closing ffmpeg process..."),i.kill("SIGINT")},3e4),console.log("ChildProcess",i)}),n.ipcMain.on("ffmpegCommandSpawn",(t,e)=>{const{command:i,args:o}=JSON.parse(e);console.log(i,o);const s=c.spawn(i,o,{windowsVerbatimArguments:!0});setTimeout(()=>{console.log("Closing ffmpeg process..."),s.kill("SIGINT")},3e4),console.log("ChildProcess",s)})},g={id:null,title:"",width:null,height:null,minWidth:null,minHeight:null,route:"",resizable:!0,maximize:!1,backgroundColor:"#eee",data:null,isMultiWindow:!1,isMainWin:!1,parentId:null,modal:!1};class w{constructor(){d(this,"main");d(this,"group");d(this,"tray");this.main=null,this.group={},this.tray=null}winOpts(e=[]){return{width:e[0],height:e[1],backgroundColor:"#f7f8fc",autoHideMenuBar:!1,resizable:!0,minimizable:!0,maximizable:!0,frame:!0,show:!1,minWidth:0,minHeight:0,modal:!0,webPreferences:{contextIsolation:!1,nodeIntegration:!0,webSecurity:!1,preload:r.join(__dirname,"../electron-preload/index.js")}}}getWindow(e){return n.BrowserWindow.fromId(e)}createWindows(e){console.log("------------creating window...");let i=Object.assign({},g,e);for(let a in this.group)if(this.getWindow(Number(a))&&this.group[a].route===i.route&&!this.group[a].isMultiWindow){this.getWindow(Number(a)).focus();return}let o=this.winOpts([i.width||1080,i.height||720]);i.parentId?o.parent=this.getWindow(i.parentId):this.main&&console.log(666),o.modal=i.modal,o.resizable=i.resizable,i.backgroundColor&&(o.backgroundColor=i.backgroundColor),i.minWidth&&(o.minWidth=i.minWidth),i.minHeight&&(o.minHeight=i.minHeight);let s=new n.BrowserWindow(o);console.log("window id: "+s),this.group[s.id]={route:i.route,isMultiWindow:i.isMultiWindow},console.log("this.group",this.group),i.maximize&&i.resizable&&s.maximize(),i.isMainWin&&(this.main&&(delete this.group[this.main.id],this.main.close()),this.main=s),i.id=s.id,s.on("close",()=>s.setOpacity(0));let l;n.app.isPackaged?l=i.route?r.join(__dirname,`../../dist/index.html${i.route}`):r.join(__dirname,"../../dist/index.html"):l=i.route?`${process.env.VITE_DEV_SERVER_URL}${i.route}?winId=${i.id}`:`${process.env.VITE_DEV_SERVER_URL}?winId=${i.id}`,console.log("new window url:",l),console.log("env",process.env.NODE_ENV),process.env.NODE_ENV==="production"?s.loadURL(r.join(__dirname,"../dist/index.html")):s.loadURL(l),s.once("ready-to-show",()=>{s.show()})}createTray(){const e=n.Menu.buildFromTemplate([{label:"注销",click:()=>{}},{type:"separator"},{label:"退出",role:"quit"}]);this.tray=new n.Tray(r.join(__dirname,"../favicon.ico")),this.tray.on("click",()=>{for(let i in this.group)this.group[i]&&this.getWindow(Number(i)).show()}),this.tray.on("right-click",()=>{var i;(i=this.tray)==null||i.popUpContextMenu(e)}),this.tray.setToolTip("小猪课堂")}listen(){n.ipcMain.on("pinUp",(e,i)=>{if(e.preventDefault(),i&&this.main.id==i){let o=this.getWindow(Number(this.main.id));o.isAlwaysOnTop()?o.setAlwaysOnTop(!1):o.setAlwaysOnTop(!0)}}),n.ipcMain.on("window-hide",(e,i)=>{if(i)this.getWindow(Number(i)).hide();else for(let o in this.group)this.group[o]&&this.getWindow(Number(o)).hide()}),n.ipcMain.on("window-show",(e,i)=>{if(i)this.getWindow(Number(i)).show();else for(let o in this.group)this.group[o]&&this.getWindow(Number(o)).show()}),n.ipcMain.on("mini",(e,i)=>{if(i)this.getWindow(Number(i)).minimize();else for(let o in this.group)this.group[o]&&this.getWindow(Number(o)).minimize()}),n.ipcMain.on("window-max",(e,i)=>{if(i)this.getWindow(Number(i)).maximize();else for(let o in this.group)this.group[o]&&this.getWindow(Number(o)).maximize()}),n.ipcMain.on("window-new",(e,i)=>this.createWindows(i)),h()}}const f=process.env.NODE_ENV!=="production";async function u(){let t=new w;t.listen(),t.createWindows({isMainWin:!0}),t.createTray()}n.app.on("window-all-closed",()=>{process.platform!=="darwin"&&n.app.quit()});n.app.on("activate",()=>{n.BrowserWindow.getAllWindows().length===0&&u()});n.app.on("ready",async()=>{u()});f&&(process.platform==="win32"?process.on("message",t=>{t==="graceful-exit"&&(console.log("graceful-exit"),n.app.quit())}):process.on("SIGTERM",()=>{n.app.quit()}));
