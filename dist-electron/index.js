"use strict";var M=Object.defineProperty;var y=(s,o,e)=>o in s?M(s,o,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[o]=e;var p=(s,o,e)=>(y(s,typeof o!="symbol"?o+"":o,e),e);const n=require("electron"),f=require("path"),h=require("child_process");var d=(s=>(s.RTMP="RTMP",s.WEBRTC="WEBRTC",s.SRT="SRT",s))(d||{});let l=null;const g=new Map,T=s=>{l=s,n.ipcMain.on("ffmpegCommandExec",(o,e)=>{console.log(e),h.exec(e,(i,t,r)=>{if(i){console.error(`exec error: ${i}`);return}console.log(`stdout: ${t}`),console.log(`stderr: ${r}`)})}),n.ipcMain.on("ffmpegCommandSpawn",(o,e)=>{const{command:i,args:t}=JSON.parse(e);console.log(i,t);const r=h.spawn(i,t,{windowsVerbatimArguments:!0});r.pid&&g.set(r.pid,r),console.log("ChildProcess pid",r.pid)}),n.ipcMain.on("ffmpegSpawnKill",(o,e)=>{g.forEach((i,t)=>{console.log("Closing ffmpeg process..."),i.kill("SIGINT"),g.delete(t)})}),n.ipcMain.on("main-ffmpeg-protocols",(o,e)=>{h.exec(e,(i,t,r)=>{if(i){console.error(`exec error: ${i}`);return}const a=/Input:\r?\n((?:\s{2}\w+\r?\n)+)/,u=t.match(a);if(u&&u[1]){const W=u[1].trim().split(`
`).map(c=>c.trim()),b=[d.RTMP,d.SRT,d.WEBRTC];let m=W.filter(c=>b.includes(c.toUpperCase()));m=m.map(c=>c.toUpperCase()),l==null||l.webContents.send("main-ffmpeg-protocols-response",JSON.stringify(m))}})}),n.ipcMain.on("main-desktop-stream",(o,e)=>{console.log("main-desktop-stream",e),n.desktopCapturer.getSources({types:["window","screen"]}).then(async i=>{for(const t of i)if(console.log("sources",t.name,t.name.includes("Electron"),t.name.includes("整个屏幕")),t.name.includes("整个屏幕")||t.name.includes("Electron")){l==null||l.webContents.send("main-desktop-stream-response",t.id),console.log(t.id);return}})})},C={id:null,title:"",width:null,height:null,minWidth:null,minHeight:null,route:"",resizable:!0,maximize:!1,backgroundColor:"#eee",data:null,isMultiWindow:!1,isMainWin:!1,parentId:null,modal:!1};class x{constructor(){p(this,"main");p(this,"group");p(this,"tray");this.main=null,this.group={},this.tray=null}winOpts(o=[]){return{width:o[0],height:o[1],backgroundColor:"#f7f8fc",autoHideMenuBar:!1,resizable:!0,minimizable:!0,maximizable:!0,frame:!0,show:!1,minWidth:0,minHeight:0,modal:!0,webPreferences:{contextIsolation:!1,nodeIntegration:!0,webSecurity:!1}}}getWindow(o){return n.BrowserWindow.fromId(o)}createWindows(o){console.log("------------creating window...");let e=Object.assign({},C,o);for(let a in this.group)if(this.getWindow(Number(a))&&this.group[a].route===e.route&&!this.group[a].isMultiWindow){this.getWindow(Number(a)).focus();return}let i=this.winOpts([e.width||1920,e.height||880]);e.parentId?i.parent=this.getWindow(e.parentId):this.main&&console.log(666),i.modal=e.modal,i.resizable=e.resizable,e.backgroundColor&&(i.backgroundColor=e.backgroundColor),e.minWidth&&(i.minWidth=e.minWidth),e.minHeight&&(i.minHeight=e.minHeight);let t=new n.BrowserWindow(i);console.log("window id: "+t.id),this.group[t.id]={route:e.route,isMultiWindow:e.isMultiWindow},console.log("this.group",this.group),e.maximize&&e.resizable&&t.maximize(),e.isMainWin&&(this.main&&(delete this.group[this.main.id],this.main.close()),this.main=t),e.id=t.id,t.on("close",()=>t.setOpacity(0));let r;n.app.isPackaged?t.loadFile(f.join(__dirname,"../dist/index.html")):(r=e.route?`${process.env.VITE_DEV_SERVER_URL}${e.route}?winId=${e.id}`:`${process.env.VITE_DEV_SERVER_URL}?winId=${e.id}`,t.loadURL(r)),t.once("ready-to-show",()=>{t.show()})}createTray(){const o=n.Menu.buildFromTemplate([{label:"注销",click:()=>{}},{type:"separator"},{label:"退出",role:"quit"}]);this.tray=new n.Tray(f.join(__dirname,"../favicon.ico")),this.tray.on("click",()=>{for(let e in this.group)this.group[e]&&this.getWindow(Number(e)).show()}),this.tray.on("right-click",()=>{var e;(e=this.tray)==null||e.popUpContextMenu(o)}),this.tray.setToolTip("小猪课堂")}listen(){n.ipcMain.on("pinUp",(o,e)=>{if(o.preventDefault(),e&&this.main.id==e){let i=this.getWindow(Number(this.main.id));i.isAlwaysOnTop()?i.setAlwaysOnTop(!1):i.setAlwaysOnTop(!0)}}),n.ipcMain.on("window-hide",(o,e)=>{if(e)this.getWindow(Number(e)).hide();else for(let i in this.group)this.group[i]&&this.getWindow(Number(i)).hide()}),n.ipcMain.on("window-show",(o,e)=>{if(e)this.getWindow(Number(e)).show();else for(let i in this.group)this.group[i]&&this.getWindow(Number(i)).show()}),n.ipcMain.on("mini",(o,e)=>{if(e)this.getWindow(Number(e)).minimize();else for(let i in this.group)this.group[i]&&this.getWindow(Number(i)).minimize()}),n.ipcMain.on("window-max",(o,e)=>{if(e)this.getWindow(Number(e)).maximize();else for(let i in this.group)this.group[i]&&this.getWindow(Number(i)).maximize()}),n.ipcMain.on("window-new",(o,e)=>this.createWindows(e)),this.main?T(this.main):console.log("main window not exists")}}const R=process.env.NODE_ENV!=="production";async function w(){let s=new x;s.createWindows({isMainWin:!0}),s.listen(),s.createTray()}n.app.on("window-all-closed",()=>{process.platform!=="darwin"&&n.app.quit()});n.app.on("activate",()=>{n.BrowserWindow.getAllWindows().length===0&&w()});n.app.on("ready",async()=>{w()});R&&(process.platform==="win32"?process.on("message",s=>{s==="graceful-exit"&&(console.log("graceful-exit"),n.app.quit())}):process.on("SIGTERM",()=>{n.app.quit()}));
